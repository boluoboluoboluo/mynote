`文档时间：20241203`

#### 准备

> 1.能上推特
>
> 2.系统已安装ffmpeg工具

#### 思路

```sh
# 1.打开网页，F12开发者工具，过滤.m3u8，分析。拿到视频碎片索引m3u8文件内容，保存到本地 m3u8.txt
# 2.编写代码，依次下载m3u8中的m4s地址的数据（注意：头部EXT-X-MAP:URI的数据为初始化数据）
	#数据全部写入到all.m4s (头部+后续每个视频地址数据碎片)
# 3.使用ffmpeg工具转码为mp4
	ffmpeg -i all.m4s -c copy out.mp4
```

#### 示例

示例视频地址：`https://x.com/elonmusk/status/1863107843337166864`

##### 分析

a. 打开网页，F12开发者工具，过滤.m3u8，分析。拿到视频碎片索引m3u8文件内容如下：

```
#EXTM3U
#EXT-X-VERSION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-TARGETDURATION:3
#EXT-X-PLAYLIST-TYPE:VOD
#EXT-X-MAP:URI="/ext_tw_video/1863014188769021953/pu/vid/avc1/0/0/1080x1900/EPYQAlxLNEcsIwdZ.mp4"
#EXTINF:3.000,
/ext_tw_video/1863014188769021953/pu/vid/avc1/0/3000/1080x1900/PRZu1B-5839KZ_Th.m4s
#EXTINF:3.000,
/ext_tw_video/1863014188769021953/pu/vid/avc1/3000/6000/1080x1900/dX7GmMfzNbhC170V.m4s
#EXTINF:3.000,
/ext_tw_video/1863014188769021953/pu/vid/avc1/6000/9000/1080x1900/HJnNxG_rFckCP1X3.m4s
#EXTINF:3.000,
/ext_tw_video/1863014188769021953/pu/vid/avc1/9000/12000/1080x1900/7njU6j9r68CqGDhJ.m4s
#EXTINF:1.966,
/ext_tw_video/1863014188769021953/pu/vid/avc1/12000/13966/1080x1900/LvkRhjRkNb0s5jfx.m4s
#EXT-X-ENDLIST
```

保存到本地`./m3u8.txt`

##### 代码

```py
import requests
import os

# video_url = "https://x.com/elonmusk/status/1863107843337166864"		#示例：视频网页地址

m3u8_file = "./m3u8.txt"		#分析得出的含有视频地址碎片的m3u8文件

video_prex = "https://video.twimg.com"		#网站域名前缀
headers = {}

fin = open(m3u8_file,"r")

allm4a = "./all.m4s"		#待合并的文件
if os.path.exists(allm4a):
	# os.remove(os.path.abspath(allm4a))				#如果文件存在，先删除
	print("file all.m4s has exists..")
	exit()

fout = open(allm4a,"ab")		#追加方式
print("start ..")
i = 0
for s in fin:
	if s.find("EXT-X-MAP") != -1:	#视频开头碎片
		v0_path = s.split("=")[1].strip().strip("\"")
		# print(v0_path)
		url = video_prex + v0_path
		r = requests.get(url,headers=headers)
		fout.write(r.content)
		print("down and merge (init segment):"+str(i))
		i = i+1

	if s.strip()[0:1] == "/":		#获取每个地址数据
		# print(s)
		url = video_prex + s.strip()
		r = requests.get(url,headers=headers)
		fout.write(r.content)
		print("down and merge :"+str(i))
		i = i+1

print("down all.")
fin.close()
if fout:
	fout.close()
```

执行代码，生成一个视频`all.m4s`文件

##### 转mp4

```sh
#命令
ffmpeg -i all.m4s -c copy video.mp4
```

文件`out.mp4`即为视频文件

#### 补充

音频同理，分析音频的m3u8文件，下载，转码

```sh
# 视频+音频合并命令
ffmpeg -i "audio.mp4" -i "video.mp4" -c copy "output.mp4"
```

