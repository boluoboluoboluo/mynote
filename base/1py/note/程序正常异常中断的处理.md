

```py
import atexit
import signal
from types import FrameType
import sys

_saved = False #全局变量

def save():
	global _saved
	if _saved:
		return
	print("save...")
    # 逻辑..
	_saved = True

#定义信号处理
def signal_handler(signum:int,frame:FrameType):
	print(f"\n接收到终止信号 ({signal.Signals(signum).name})，开始保存...")
	save()
	sys.exit(128 + signum)	# 遵循Linux退出码规范

#定义异常捕获
def exception_handler(exc_type, exc_value, traceback):
	print(f"\n发生未处理异常: {exc_type.__name__}: {exc_value}，开始保存")
	save()
	# 调用默认异常处理确保正确打印堆栈信息
	sys.__excepthook__(exc_type, exc_value, traceback)
	sys.exit(1)

#定义程序正常异常退出，中断信号的处理
def register_handlers():
	#程序正常退出
	atexit.register(save)

	#信号处理(ctrl+c或者kill命令)
	for sig in [signal.SIGINT,signal.SIGTERM]:
		signal.signal(sig,signal_handler)

	#全局异常捕获（不包括子线程）
	sys.excepthook = exception_handler	

def main():
	register_handlers()

	try:
		while True:
			data = input("输入内容：")
			if not data:
				raise ValueError("空输入异常")
			print(f"您输入的是:{data}")
	except KeyboardInterrupt:
		#此处已被信号处理接管
		pass

if __name__ == '__main__':
	main()
```



### **终端关闭的几种场景**

| 场景             | 典型触发方式                  | 信号类型  | 是否可捕获？                       |
| :--------------- | :---------------------------- | :-------- | :--------------------------------- |
| **正常关闭**     | 用户主动关闭终端窗口          | `SIGHUP`  | 是                                 |
| **Ctrl+C**       | 用户按下 `Ctrl+C`             | `SIGINT`  | 是（默认触发 `KeyboardInterrupt`） |
| **系统终止信号** | `kill <pid>` 或系统任务管理器 | `SIGTERM` | 是                                 |
| **强制终止**     | `kill -9 <pid>`               | `SIGKILL` | 否（无法被捕获或处理）             |

### **操作系统差异**

| 信号类型  | Windows 支持           | Linux/macOS 支持 | 行为差异                     |
| :-------- | :--------------------- | :--------------- | :--------------------------- |
| `SIGINT`  | 是（Ctrl+C）           | 是               | 行为一致                     |
| `SIGTERM` | 有限支持（需第三方库） | 是               | Windows 默认无此信号         |
| `SIGHUP`  | 不支持                 | 是               | Windows 关闭终端直接终止进程 |
